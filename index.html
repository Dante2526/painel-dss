<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Painel de Acompanhamento DSS (Firebase)</title>
    <style>
        :root {
            --primary-color: #0080ff;
            --primary-light: #4da3ff;
            --primary-dark: #0066cc;
            --success-color: #5ec269;
            --danger-color: #ff5252;
            --danger-dark: #d32f2f;
            --neutral-color: #8b95a1;
            --warning-color: #ffc107;
            --orange-color: #ff9800;

            --bg-primary: #ffffff;
            --bg-secondary: #f5f7fa;
            --bg-card: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --body-bg-gradient-start: #f5f7fa;
            --body-bg-gradient-end: #e8ecf1;
            --input-border-color: #e0e0e0;

            --border-radius: 20px;
            --border-radius-small: 12px;
            --shadow-small: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-large: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        body.dark-mode {
            --bg-primary: #1A202C;
            --bg-secondary: #2D3748;
            --bg-card: #2D3748;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --body-bg-gradient-start: #2D3748;
            --body-bg-gradient-end: #1A202C;
            --input-border-color: #4A5568;
            --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.3);
            --shadow-large: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--body-bg-gradient-end);
            transition: background-color 0.4s, color 0.4s;
        }

        .viewport {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            background: linear-gradient(135deg, var(--body-bg-gradient-start) 0%, var(--body-bg-gradient-end) 100%);
             transition: background 0.4s ease;
        }

        .scalable-container {
            transform-origin: 0 0;
            width: 2448px;
            min-height: 100vh;
            position: relative;
        }

        .container {
            width: 2384px;
            margin: 0 auto;
            padding: 32px;
        }

        .header {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 40px;
            margin-bottom: 32px;
            box-shadow: var(--shadow-medium);
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 2384px;
            transition: background-color 0.4s;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-left h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-left p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .header-title-wrapper {
            display: flex;
            flex-direction: column;
        }

        #header-loader {
            width: 24px;
            height: 24px;
            border: 3px solid var(--primary-light);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin-main 1s linear infinite;
            transition: opacity 0.3s ease;
             opacity: 1;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 20px;
        }

        .top-controls {
            display: flex;
            gap: 20px;
            align-items: flex-end;
        }

        .header-stats {
            display: flex;
            gap: 24px;
        }

        .stat-card {
            text-align: center;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-radius: var(--border-radius-small);
            min-width: 100px;
            transition: background-color 0.4s;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
            transition: all 0.3s ease;
        }

        .stat-number.positive { color: var(--success-color); }
        .stat-number.negative { color: var(--danger-color); }
        .stat-number.neutral { color: var(--neutral-color); }
        .stat-number.warning { color: var(--warning-color); }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
        }

        .manual-register-section {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: var(--shadow-medium);
            display: flex;
            align-items: center;
            gap: 24px;
            width: auto;
            max-width: 1100px;
            margin-left: 0;
            margin-right: auto;
            transition: background-color 0.4s;
        }

        .input-wrapper {
            position: relative;
            flex: 1;
            display: flex;
            align-items: center;
        }

        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .manual-register-section input {
            width: 100%;
            padding: 16px 16px 16px 48px;
            border-radius: var(--border-radius-small);
            border: 2px solid var(--input-border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.4s;
        }

        .manual-register-section input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 128, 255, 0.2);
        }

        #register-presence-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px 36px;
            font-size: 16px;
            font-weight: 700;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 10px 32px rgba(0, 128, 255, 0.35);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        #register-presence-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 14px 40px rgba(0, 128, 255, 0.45);
        }

        #register-presence-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 128, 255, 0.3);
        }

        #register-presence-btn .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 5px;
            width: 0;
            background-color: rgba(255,255,255,0.4);
        }

        #register-presence-btn.loading .progress-bar {
            width: 100%;
            transition: width 2s linear;
        }

        #notification-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .notification {
            background-color: #333;
            color: white;
            padding: 15px 25px;
            border-radius: var(--border-radius-small);
            box-shadow: var(--shadow-large);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            font-weight: 600;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success { background-color: var(--success-color); }
        .notification.error { background-color: var(--danger-color); }

        #main-panel-wrapper {
            display: flex;
            gap: 32px;
            width: 100%;
            max-width: 2384px;
        }

        #dss-task-panel {
            width: 752px;
            flex-shrink: 0;
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 32px;
            box-shadow: var(--shadow-medium);
            height: fit-content;
            transition: background-color 0.4s;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            position: relative;
            min-height: 200px;
        }

        .special-team-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--input-border-color);
            text-align: center;
            width: 100%;
        }

        #dss-task-panel .input-wrapper {
             width: 100%;
        }

        #dss-task-panel input {
            width: 100%;
            padding: 16px 16px 16px 48px;
            border-radius: var(--border-radius-small);
            border: 2px solid var(--input-border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.4s;
        }

        #dss-task-panel input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 128, 255, 0.2);
        }

        .special-team-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 80%;
            max-width: 500px;
            align-items: stretch;
            margin-bottom: 16px;
        }

        .special-team-form .input-wrapper {
             width: 100%;
        }

        #register-presence-btn-special {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px 36px;
            font-size: 16px;
            font-weight: 700;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 10px 32px rgba(0, 128, 255, 0.35);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        #register-presence-btn-special:hover {
            transform: translateY(-3px);
            box-shadow: 0 14px 40px rgba(0, 128, 255, 0.45);
        }

        #register-presence-btn-special:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 128, 255, 0.3);
        }

        #register-presence-btn-special .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 5px;
            width: 0;
            background-color: rgba(255,255,255,0.4);
        }

        #register-presence-btn-special.loading .progress-bar {
            width: 100%;
            transition: width 2s linear;
        }

        #register-presence-btn-special.loading .button-text {
             opacity: 0.5;
        }

        #register-presence-btn-special.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        #special-team-list {
            display: flex;
            flex-direction: column;
            gap: 24px;
             width: 100%;
             position: relative;
             min-height: 100px;
        }

        #special-team-list .employee-block {
            width: 100%;
        }

        .turno-button.active {
            background: linear-gradient(135deg, #0056b3 0%, #004080 100%);
            color: #e0e0e0;
        }

        .table-container {
            flex-grow: 1;
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 32px;
            box-shadow: var(--shadow-medium);
            display: flex;
            gap: 32px;
            transition: background-color 0.4s;
            width: auto;
            position: relative;
            min-height: 200px;
        }

        .loading-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-secondary);
            font-style: italic;
            text-align: center;
            width: 90%;
            pointer-events: none;
            display: none;
            z-index: 5;
        }
        .loading-placeholder.show {
            display: block;
        }

        #special-team-list .loading-placeholder {
            top: 30px;
            transform: translateX(-50%);
            left: 50%;
        }

        .column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 24px;
            width: auto;
            min-width: 0;
        }

        .employee-block {
            background: var(--bg-secondary);
            border-radius: var(--border-radius-small);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            height: fit-content;
        }

        #dss-task-panel .employee-block {
            width: 100%;
        }

        .employee-block:hover {
            box-shadow: var(--shadow-large);
            transform: translateY(-4px);
        }

        .employee-header {
            display: flex;
            align-items: center;
            padding: 24px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            transition: background 0.3s ease;
            position: relative;
            flex-wrap: nowrap;
        }

        .employee-header.positive { background: linear-gradient(135deg, var(--success-color) 0%, #4caf50 100%); }
        .employee-header.negative { background: linear-gradient(135deg, var(--danger-color) 0%, #f44336 100%); }
        .employee-header.neutral { background: linear-gradient(135deg, var(--neutral-color) 0%, #757575 100%); }
        .employee-header.warning { background: linear-gradient(135deg, var(--warning-color) 0%, #f57c00 100%); }

        .employee-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 20px;
            flex-shrink: 0;
        }

        .employee-info {
            flex-grow: 1;
            min-width: 0;
            margin-right: 15px;
        }

        .employee-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .employee-matricula {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .employee-header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: nowrap;
            align-items: center;
        }

        .turno-button, .absent-button, .remove-button {
            white-space: nowrap;
            min-width: auto;
            padding: 12px 16px;
            font-size: 13px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .turno-button {
            background: linear-gradient(135deg, #F97316 0%, #EA580C 100%);
            color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .turno-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .turno-button.loading {
            pointer-events: none;
        }

        .turno-button .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 5px;
            width: 0;
            background: rgba(255, 255, 255, 0.5);
        }

        .turno-button.loading .progress-bar {
            width: 100%;
            transition: width 2s linear;
        }

        .turno-button-content {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .turno-button span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80px;
        }

        .turno-button .loading-state,
        .turno-button .success-state {
            display: none;
        }
        .turno-button.loading .default-state,
        .turno-button.success .default-state {
            display: none;
        }
        .turno-button.loading .loading-state {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .turno-button.success .success-state {
            display: flex;
        }

        .turno-button .spinner {
            width: 16px;
            height: 16px;
            border: 2.5px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        .button-icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
            flex-shrink: 0;
        }

        .remove-button {
            background: linear-gradient(135deg, var(--danger-color) 0%, var(--danger-dark) 100%);
            color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.admin-mode .remove-button {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        .remove-button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .remove-button:active {
            transform: translateY(0) scale(0.98);
        }

        .remove-button.loading {
            pointer-events: none;
        }

        .remove-button .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 5px;
            width: 0;
            background: rgba(255, 255, 255, 0.5);
        }

        .remove-button.loading .progress-bar {
            width: 100%;
            transition: width 2s linear;
        }

        .remove-button-content {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .remove-button .loading-state,
        .remove-button .success-state {
            display: none;
        }
        .remove-button.loading .default-state,
        .remove-button.success .default-state {
            display: none;
        }
        .remove-button.loading .loading-state {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .remove-button.success .success-state {
            display: flex;
        }

        .checkboxes-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            padding: 24px;
        }

        #dss-task-panel .checkboxes-row {
            grid-template-columns: repeat(3, 1fr);
        }

        .checkbox-item {
            background: var(--bg-primary);
            border-radius: var(--border-radius-small);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 3px solid transparent;
            position: relative;
            min-width: 0;
        }

        .employee-block .checkbox-item {
            padding: 16px;
            gap: 10px;
        }
        .employee-block .checkbox-icon {
            font-size: 32px;
        }
        .employee-block .checkbox-text {
            font-size: 13px;
        }

        .checkbox-item:hover {
            transform: scale(1.08);
            box-shadow: var(--shadow-medium);
        }

        body:not(.dark-mode) .checkbox-item.checked-ass-dss {
            background: #f5f5f5;
            border-color: var(--neutral-color);
        }

        body:not(.dark-mode) .checkbox-item.checked-bem {
            background: #e8f5e9;
            border-color: var(--success-color);
        }

        body:not(.dark-mode) .checkbox-item.checked-mal {
            background: #ffebee;
            border-color: var(--danger-color);
        }

        body.dark-mode .checkbox-item {
            border-color: transparent !important;
        }

        body.dark-mode .checkbox-item.checked-ass-dss {
            background: #4A5568;
        }

        body.dark-mode .checkbox-item.checked-bem {
             background: #2F855A;
        }

        body.dark-mode .checkbox-item.checked-mal {
            background: #C53030;
        }

        .checkbox-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            text-align: center;
            pointer-events: none;
            width: 100%;
        }

        .checkbox-icon {
            font-size: 40px;
            filter: grayscale(100%);
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .checkbox-item.checked-ass-dss .checkbox-icon,
        .checkbox-item.checked-bem .checkbox-icon,
        .checkbox-item.checked-mal .checkbox-icon {
            filter: grayscale(0%);
            opacity: 1;
        }

        .checkbox-text {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .checkbox-item.checked-ass-dss .checkbox-text { color: var(--neutral-color); }
        .checkbox-item.checked-bem .checkbox-text { color: var(--success-color); }
        .checkbox-item.checked-mal .checkbox-text { color: var(--danger-color); }

        body.dark-mode .checkbox-item.checked-ass-dss .checkbox-text,
        body.dark-mode .checkbox-item.checked-bem .checkbox-text,
        body.dark-mode .checkbox-item.checked-mal .checkbox-text {
            color: white;
        }

        .real-checkbox {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .custom-checkbox {
            width: 32px;
            height: 32px;
            border: 3px solid #ddd;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            pointer-events: none;
        }

        .employee-block .custom-checkbox {
            width: 28px;
            height: 28px;
        }

        .custom-checkbox::after {
            content: "✓";
            color: white;
            font-size: 18px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .employee-block .custom-checkbox::after {
            font-size: 16px;
        }

        .checkbox-item input[type="checkbox"]:checked + .custom-checkbox::after {
            opacity: 1;
        }

        .checkbox-item.checked-ass-dss input[type="checkbox"]:checked + .custom-checkbox {
            background: var(--neutral-color);
            border-color: var(--neutral-color);
        }

        .checkbox-item.checked-bem input[type="checkbox"]:checked + .custom-checkbox {
            background: var(--success-color);
            border-color: var(--success-color);
        }

        .checkbox-item.checked-mal input[type="checkbox"]:checked + .custom-checkbox {
            background: var(--danger-color);
            border-color: var(--danger-color);
        }

        .timestamp-row {
            padding: 0 24px 24px 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .timestamp {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 12px 20px;
            text-align: center;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-secondary);
            width: auto;
            min-width: 200px;
            margin: 0 auto;
        }

        .timestamp.has-time {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }

        .timestamp-label {
            text-align: center;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-card {
            background: var(--bg-card);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-large);
            width: 90%;
            max-width: 500px;
            text-align: center;
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s ease, background-color 0.4s;
        }

        .modal-overlay.visible .modal-card {
            transform: scale(1);
        }

        .close-modal-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 30px;
            line-height: 1;
            color: #aaa;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close-modal-btn:hover {
            color: #333;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 24px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-primary);
        }

        .modal-input-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 24px;
        }
        .modal-input-wrapper .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .modal-input {
            width: 100%;
            padding: 16px;
            border-radius: var(--border-radius-small);
            border: 2px solid var(--input-border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            margin-bottom: 24px;
            text-align: center;
        }

        .modal-input-wrapper .modal-input {
            padding: 16px 16px 16px 48px;
            text-align: left;
            margin-bottom: 0;
        }

        #new-user-name {
            text-transform: uppercase;
        }

        .modal-input::placeholder {
            text-transform: uppercase;
        }
        .modal-input.error {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 3px rgba(255, 82, 82, 0.2);
        }

        .modal-button {
            width: 100%;
            padding: 16px;
            border: none;
            color: white;
            font-size: 16px;
            font-weight: 600;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .modal-button:hover:not(.loading) {
            opacity: 0.9;
        }

        .modal-button.loading .button-text {
            opacity: 0;
        }
        .modal-button .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 3;
        }
        .modal-button.loading .spinner {
            display: block;
        }

        #submit-login-btn {
            background-color: #6B46C1;
        }
        #submit-login-btn:hover:not(.loading) {
            background-color: #553c9a;
        }

        .modal-button-green {
            background-color: var(--success-color);
        }
        .modal-button-green:hover:not(.loading) {
            background-color: #4caf50;
        }

        .admin-options-buttons {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .admin-option-btn {
            padding: 18px;
            font-size: 16px;
            font-weight: 700;
            border: none;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .admin-option-btn:hover:not(.loading) {
            opacity: 0.9;
            transform: translateY(-3px);
        }

        .admin-option-btn.orange { background-color: var(--orange-color); color: white;}
        .admin-option-btn.blue { background-color: var(--primary-color); }
        .admin-option-btn.red { background-color: var(--danger-color); }
        .admin-option-btn.green { background-color: var(--success-color); }

        .admin-button {
            position: relative;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 28px;
            padding: 0 40px;
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
            letter-spacing: 1px;
            display: inline-flex;
            align-items: center;
            gap: 14px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            height: 90px;
        }

        .admin-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0) 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .admin-button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 16px 48px rgba(102, 126, 234, 0.5);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .admin-button:hover::before {
            opacity: 1;
        }

        .admin-button:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }

        .admin-button:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.3), 0 16px 48px rgba(102, 126, 234, 0.5);
        }

        .admin-button .icon {
            width: 26px;
            height: 26px;
            fill: currentColor;
            transition: transform 0.3s ease;
            z-index: 2;
        }

        .admin-button:hover .icon {
            transform: rotate(360deg);
        }

        .admin-button.loading .button-text,
        .admin-button.loading .icon {
            opacity: 0;
        }

        .admin-button.loading .spinner {
            display: block;
        }

        .spinner {
            display: none;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 3;
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: scale(0);
            animation: ripple-animation 0.6s ease-out;
            pointer-events: none;
        }

        .absent-button .ripple {
             background: rgba(255, 255, 255, 0.5);
        }

        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        .absent-button {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 700;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.8px;
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
            width: auto;
            min-width: 120px;
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
            box-shadow: 0 10px 32px rgba(217, 119, 6, 0.35);
            text-transform: uppercase;
             position: relative;
             overflow: hidden;
        }
        .absent-button .button-icon{
             margin-right: 8px;
             color: white;
        }

        .absent-button.marked {
            transform: translateY(1px);
            box-shadow: 0 6px 20px rgba(217, 119, 6, 0.3);
            background: linear-gradient(135deg, #D97706 0%, #B45309 100%);
        }

        .absent-button:hover:not(.marked) {
            transform: translateY(-3px);
            box-shadow: 0 14px 40px rgba(217, 119, 6, 0.45);
        }

        .absent-button:active:not(.marked) {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(217, 119, 6, 0.3);
        }

        /* BB-8 TOGGLE STYLES */
        .bb8-toggle{--toggle-size:16px;--toggle-width:10.625em;--toggle-height:5.625em;--toggle-offset:calc((var(--toggle-height) - var(--bb8-diameter))/ 2);--toggle-bg:linear-gradient(#2c4770,#070e2b 35%,#628cac 50% 70%,#a6c5d4) no-repeat;--bb8-diameter:4.375em;--radius:99em;--transition:.4s;--accent:#de7d2f;--bb8-bg:#fff;cursor:pointer;font-size:var(--toggle-size);margin-top:2.5em}.bb8-toggle,.bb8-toggle *,.bb8-toggle *::after,.bb8-toggle *::before{box-sizing:border-box}.bb8-toggle__checkbox{appearance:none;display:none}.bb8-toggle__container{width:var(--toggle-width);height:var(--toggle-height);background:var(--toggle-bg);background-size:100% 11.25em;background-position-y:-5.625em;border-radius:var(--radius);position:relative;transition:var(--transition)}.bb8{display:flex;flex-direction:column;align-items:center;position:absolute;top:calc(var(--toggle-offset) - 1.8em);left:var(--toggle-offset);transition:var(--transition);z-index:10}.bb8__head-container{position:relative;transition:var(--transition);z-index:11;transform-origin:1.25em 3.75em}.bb8__head{overflow:hidden;margin-bottom:-.188em;width:2.5em;height:1.688em;background:linear-gradient(transparent .063em,#696969 .063em .313em,transparent .313em .375em,var(--accent) .375em .5em,transparent .5em 1.313em,#c0c0c0 1.313em 1.438em,transparent 1.438em),linear-gradient(45deg,transparent .188em,var(--bb8-bg) .188em 1.25em,transparent 1.25em),linear-gradient(-45deg,transparent .188em,var(--bb8-bg) .188em 1.25em,transparent 1.25em),linear-gradient(var(--bb8-bg) 1.25em,transparent 1.25em);border-radius:var(--radius) var(--radius) 0 0;position:relative;z-index:1;filter:drop-shadow(0 .063em .125em gray)}.bb8__head::before{content:"";position:absolute;width:.563em;height:.563em;background:radial-gradient(.125em circle at .25em .375em,red,transparent),radial-gradient(.063em circle at .375em .188em,var(--bb8-bg) 50%,transparent 100%),linear-gradient(45deg,#000 .188em,#696969 .313em .375em,#000 .5em);border-radius:var(--radius);top:.413em;left:50%;transform:translate(-50%);box-shadow:0 0 0 .089em #d3d3d3,.563em .281em 0 -.148em,.563em .281em 0 -.1em var(--bb8-bg),.563em .281em 0 -.063em;z-index:1;transition:var(--transition)}.bb8__head::after{content:"";position:absolute;bottom:.375em;left:0;width:100%;height:.188em;background:linear-gradient(90deg,var(--accent) .125em,transparent .125em .188em,var(--accent) .188em .313em,transparent .313em .375em,var(--accent) .375em .938em,transparent .938em 1em,var(--accent) 1em 1.125em,transparent 1.125em 1.875em,var(--accent) 1.875em 2em,transparent 2em 2.063em,var(--accent) 2.063em 2.25em,transparent 2.25em 2.313em,var(--accent) 2.313em 2.375em,transparent 2.375em 2.438em,var(--accent) 2.438em);transition:var(--transition)}.bb8__antenna{position:absolute;transform:translateY(-90%);width:.059em;border-radius:var(--radius) var(--radius) 0 0;transition:var(--transition)}.bb8__antenna:first-child{height:.938em;right:.938em;background:linear-gradient(#000 .188em,#c0c0c0 .188em)}.bb8__antenna:nth-child(2){height:.375em;left:50%;transform:translate(-50%,-90%);background:#c0c0c0}.bb8__body{width:4.375em;height:4.375em;background:var(--bb8-bg);border-radius:var(--radius);position:relative;overflow:hidden;transition:var(--transition);z-index:9;transform:rotate(45deg);background:linear-gradient(-90deg,var(--bb8-bg) 4%,var(--accent) 4% 10%,transparent 10% 90%,var(--accent) 90% 96%,var(--bb8-bg) 96%),linear-gradient(var(--bb8-bg) 4%,var(--accent) 4% 10%,transparent 10% 90%,var(--accent) 90% 96%,var(--bb8-bg) 96%),linear-gradient(90deg,transparent 2.156em,#c0c0c0 2.156em 2.219em,transparent 2.188em),linear-gradient(transparent 2.156em,#c0c0c0 2.156em 2.219em,transparent 2.188em);background-color:var(--bb8-bg)}.bb8__body::after{content:"";bottom:1.5em;left:.563em;position:absolute;width:.188em;height:.188em;background:#ececec;border-radius:50%;box-shadow:.875em .938em,0 -1.25em,.875em -2.125em,2.125em -2.125em,3.063em -1.25em,3.063em 0,2.125em .938em}.bb8__body::before{content:"";width:2.625em;height:2.625em;position:absolute;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%);border:.313em solid var(--accent);background:radial-gradient(1em circle at center,#ececec 50%,transparent 51%),radial-gradient(1.25em circle at center,var(--bb8-bg) 50%,transparent 51%),linear-gradient(-90deg,transparent 42%,var(--accent) 42% 58%,transparent 58%),linear-gradient(var(--bb8-bg) 42%,var(--accent) 42% 58%,var(--bb8-bg) 58%)}.artificial__hidden{position:absolute;border-radius:inherit;inset:0;pointer-events:none;overflow:hidden}.bb8__shadow{width:var(--bb8-diameter);height:.875em;border-radius:50%;background:#3a271c;box-shadow:.313em 0 3.125em #3a271c;opacity:.25;position:absolute;bottom:.175em;left:calc(var(--toggle-offset) - .938em);transition:var(--transition);transform:skew(-70deg);z-index:2}.tatto-1{position:absolute;width:1.25em;height:1.25em;background:#fefefe;border-radius:var(--radius);box-shadow:0 0 .438em #fdf4e1;top:.5em;right:3em;z-index:6;transition:all var(--transition) ease-in-out;opacity:1}.tatto-2{position:absolute;width:1.25em;height:1.25em;background:linear-gradient(#ffd700,#ff8c00);border-radius:var(--radius);box-shadow:0 0 .5em gold,0 0 1em #ff8c00;top:1.75em;right:1.5em;z-index:6;transition:all var(--transition) ease-in-out;opacity:1}.bb8-toggle__scenery{width:100%;height:100%;pointer-events:none;overflow:hidden;position:relative;border-radius:inherit}.bb8-toggle__scenery::before{content:"";position:absolute;width:100%;height:30%;bottom:0;background:#b18d71;z-index:1}.bb8-toggle__cloud{z-index:1;position:absolute;border-radius:50%}.bb8-toggle__cloud:nth-last-child(1){width:.875em;height:.625em;filter:blur(.125em) drop-shadow(.313em .313em #ffffffae) drop-shadow(-.625em 0 #fff) drop-shadow(-.938em -.125em #fff);right:1.875em;top:2.813em;background:linear-gradient(to top right,#ffffffae,#ffffffae);transition:var(--transition)}.bb8-toggle__cloud:nth-last-child(2){top:.625em;right:4.375em;width:.875em;height:.375em;background:#dfdedeae;filter:blur(.125em) drop-shadow(-.313em -.188em #e0dfdfae) drop-shadow(-.625em -.188em #bbbbbbae) drop-shadow(-1em .063em #cfcfcfae);transition:.6s}.bb8-toggle__cloud:nth-last-child(3){top:1.25em;right:.938em;width:.875em;height:.375em;background:#ffffffae;filter:blur(.125em) drop-shadow(.438em .188em #ffffffae) drop-shadow(-.625em .313em #ffffffae);transition:.8s}.chenini,.gomrassen,.hermes{position:absolute;border-radius:var(--radius);background:linear-gradient(#fff,#6e8ea2);top:100%}.gomrassen{left:.938em;width:1.875em;height:1.875em;box-shadow:0 0 .188em #ffffff52,0 0 .188em #6e8ea24b;transition:var(--transition)}.gomrassen::after,.gomrassen::before{content:"";position:absolute;border-radius:inherit;box-shadow:inset 0 0 .063em #8ca2a9;background:#b8c4c8}.gomrassen::before{left:.313em;top:.313em;width:.438em;height:.438em}.gomrassen::after{width:.25em;height:.25em;left:1.25em;top:.75em}.hermes{left:3.438em;width:.625em;height:.625em;box-shadow:0 0 .125em #ffffff52,0 0 .125em #6e8ea24b;transition:.6s}.chenini{left:4.375em;width:.5em;height:.5em;box-shadow:0 0 .125em #ffffff52,0 0 .125em #6e8ea24b;transition:.8s}.bb8-toggle__star{position:absolute;width:.063em;height:.063em;background:#fff;border-radius:var(--radius);filter:drop-shadow(0 0 .063em #fff);top:100%}.bb8-toggle__checkbox:checked+.bb8-toggle__container .bb8-toggle__scenery .bb8-toggle__star:nth-child(1){top:.625em}.bb8-toggle__checkbox:checked+.bb8-toggle__container .bb8-toggle__scenery .bb8-toggle__star:nth-child(2){top:1.875em}.bb8-toggle__checkbox:checked+.bb8-toggle__container .bb8-toggle__scenery .bb8-toggle__star:nth-child(3){top:1.25em}.bb8-toggle__checkbox:checked+.bb8-toggle__container .bb8-toggle__scenery .bb8-toggle__star:nth-child(4){top:3.438em}.bb8-toggle__checkbox:checked+.bb8-toggle__container .bb8-toggle__scenery .bb8-toggle__star:nth-child(5){top:3.438em}.bb8-toggle__checkbox:checked+.bb8-toggle__container .bb8-toggle__scenery .bb8-toggle__star:nth-child(6){top:.313em}.bb8-toggle__checkbox:checked+.bb8-toggle__container .bb8-toggle__scenery .bb8-toggle__star:nth-child(7){top:1.875em}.bb8-toggle__star:nth-child(1){left:3.75em;box-shadow:1.25em .938em,-1.25em 2.5em,0 1.25em,1.875em .625em,-3.125em 1.875em,1.25em 2.813em;transition:.2s}.bb8-toggle__star:nth-child(2){left:4.688em;box-shadow:.625em 0,0 .625em,-.625em -.625em,.625em .938em,-3.125em 1.25em,1.25em -1.563em;transition:.3s}.bb8-toggle__star:nth-child(3){left:5.313em;box-shadow:-.625em -.625em,-2.188em 1.25em,-2.188em 0,-3.75em -.625em,-3.125em -.625em,-2.5em -.313em,.75em -.625em;transition:var(--transition)}.bb8-toggle__star:nth-child(4),.bb8-toggle__star:nth-child(5),.bb8-toggle__star:nth-child(6),.bb8-toggle__star:nth-child(7){width:.125em;height:.125em}.bb8-toggle__star:nth-child(4){left:1.875em;transition:.5s}.bb8-toggle__star:nth-child(5){left:5em;transition:.6s}.bb8-toggle__star:nth-child(6){left:2.5em;transition:.7s}.bb8-toggle__star:nth-child(7){left:3.438em;transition:.8s}.bb8-toggle__checkbox:checked+.bb8-toggle__container{background-position-y:0}.bb8-toggle__checkbox:checked+.bb8-toggle__container .bb8{left:calc(100% - var(--bb8-diameter) - var(--toggle-offset))}.bb8-toggle__checkbox:checked+.bb8-toggle__container .bb8__body{transform:rotate(225deg)}.bb8-toggle__checkbox:checked+.bb8-toggle__container .artificial__hidden .bb8__shadow{left:calc(100% - var(--bb8-diameter) - var(--toggle-offset) + .938em);transform:skew(70deg)}.bb8-toggle__checkbox:checked+.bb8-toggle__container .bb8-toggle__scenery .bb8-toggle__cloud{right:-100%}.bb8-toggle__checkbox:checked+.bb8-toggle__container .bb8-toggle__scenery .gomrassen{top:.938em}.bb8-toggle__checkbox:checked+.bb8-toggle__container .bb8-toggle__scenery .hermes{top:2.5em}.bb8-toggle__checkbox:checked+.bb8-toggle__container .bb8-toggle__scenery .chenini{top:2.75em}.bb8-toggle__checkbox:checked+.bb8-toggle__container .bb8-toggle__scenery .tatto-1{top:100%}.bb8-toggle__checkbox:checked+.bb8-toggle__container .bb8-toggle__scenery .tatto-2{top:100%}

        @keyframes spin-main { to { transform: rotate(360deg); } }
        @keyframes spin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .admin-option-btn.loading {
            position: relative;
            pointer-events: none;
            color: transparent !important;
        }
        .admin-option-btn.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>
<body>
    <div id="notification-area"></div>

    <div class="viewport" id="viewport">
        <div class="scalable-container" id="scalable-container">
            <div class="container">
                <div class="header">
                    <div class="header-left">
                        <div id="header-loader"></div>
                        <div class="header-title-wrapper">
                            <h1>🛡️ Painel de Acompanhamento DSS</h1>
                            <p>Diálogo Diário de Segurança - Monitoramento Firebase</p>
                        </div>
                    </div>
                    <div class="header-right">
                        <div class="top-controls">
                             <label class="bb8-toggle" for="darkModeToggle" aria-label="Alternar modo escuro">
                                <input class="bb8-toggle__checkbox" type="checkbox" id="darkModeToggle">
                                <div class="bb8-toggle__container">
                                    <div class="bb8-toggle__scenery">
                                        <div class="bb8-toggle__star"></div>
                                        <div class="bb8-toggle__star"></div>
                                        <div class="bb8-toggle__star"></div>
                                        <div class="bb8-toggle__star"></div>
                                        <div class="bb8-toggle__star"></div>
                                        <div class="bb8-toggle__star"></div>
                                        <div class="bb8-toggle__star"></div>
                                        <div class="tatto-1" aria-hidden="true"></div>
                                        <div class="tatto-2" aria-hidden="true"></div>
                                        <div class="gomrassen"></div>
                                        <div class="hermes"></div>
                                        <div class="chenini"></div>
                                        <div class="bb8-toggle__cloud"></div>
                                        <div class="bb8-toggle__cloud"></div>
                                        <div class="bb8-toggle__cloud"></div>
                                    </div>
                                    <div class="bb8">
                                        <div class="bb8__head-container">
                                            <div class="bb8__antenna"></div>
                                            <div class="bb8__antenna"></div>
                                            <div class="bb8__head"></div>
                                        </div>
                                        <div class="bb8__body"></div>
                                    </div>
                                    <div class="artificial__hidden" aria-hidden="true">
                                        <div class="bb8__shadow"></div>
                                    </div>
                                </div>
                            </label>
                            <button class="admin-button" id="admin-access-btn" aria-label="Acesso Administrativo">
                                <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                                </svg>
                                <span class="button-text">ACESSO ADM</span>
                                <div class="spinner"></div>
                            </button>
                        </div>
                        <div class="header-stats">
                            <div class="stat-card">
                                <div class="stat-number positive" id="stat-bem">0</div>
                                <div class="stat-label">Estou Bem</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number negative" id="stat-mal">0</div>
                                <div class="stat-label">Não Bem</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number warning" id="stat-absent">0</div>
                                <div class="stat-label">Ausente</div>
                            </div>
                             <div class="stat-card">
                                <div class="stat-number neutral" id="stat-total">0</div>
                                <div class="stat-label">Total</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulário alinhado à esquerda (TURNO 7H-19H) -->
                <div class="manual-register-section">
                    <div class="input-wrapper">
                        <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                            <line x1="10" y1="9" x2="8" y2="9"/>
                        </svg>
                        <input type="text" id="dss-subject" placeholder="Assunto do DSS (7H-19H)">
                    </div>
                    <div class="input-wrapper">
                        <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <input type="text" id="user-matricula" placeholder="Sua Matrícula">
                    </div>
                    <button id="register-presence-btn">REGISTRAR</button>
                </div>

                <!-- Painel principal com colunas e novo painel de tarefas -->
                <div id="main-panel-wrapper">
                    <div class="table-container" id="table-container">
                         <div class="loading-placeholder show" id="main-loading-placeholder">Carregando funcionários...</div>
                        <div class="column" id="left-column"></div>
                        <div class="column" id="right-column"></div>
                    </div>

                    <!-- Novo Painel de Tarefas (TURMA 6H) -->
                    <div id="dss-task-panel">
                        <h2 class="special-team-title">TURMA 6H</h2>
                        <div class="special-team-form">
                            <div class="input-wrapper">
                                <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                    <line x1="10" y1="9" x2="8" y2="9"/>
                                </svg>
                                <input type="text" id="dss-subject-special" placeholder="Assunto do DSS (6H)">
                            </div>
                            <div class="input-wrapper">
                                <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                                <input type="text" id="user-matricula-special" placeholder="Sua Matrícula (6H)">
                            </div>
                        </div>
                        <button id="register-presence-btn-special">
                            <span class="button-text">REGISTRAR</span>
                            <div class="progress-bar"></div>
                        </button>
                         <!-- Lista de funcionários da Turma Especial -->
                        <div id="special-team-list">
                             <div class="loading-placeholder show" id="special-loading-placeholder">Carregando funcionários...</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ===== MODAIS ===== -->

    <!-- Modal Login Admin -->
    <div id="admin-login-modal" class="modal-overlay">
        <div class="modal-card">
            <button class="close-modal-btn" id="close-login-modal-btn">&times;</button>
            <h2 class="modal-title">ACESSO ADMINISTRATIVO</h2>
            <input type="email" id="admin-email-input" class="modal-input" placeholder="Digite seu e-mail de acesso">
            <button id="submit-login-btn" class="modal-button">
                 <span class="button-text">ACESSAR</span>
                 <div class="spinner"></div>
            </button>
        </div>
    </div>

    <!-- Modal Opções Admin -->
    <div id="admin-options-modal" class="modal-overlay">
        <div class="modal-card">
            <button class="close-modal-btn" id="close-options-modal-btn">&times;</button>
            <h2 class="modal-title">OPÇÕES ADMINISTRATIVAS</h2>
            <div class="admin-options-buttons">
                <button id="btn-limpar" class="admin-option-btn orange">LIMPAR</button>
                <button id="btn-relatorio" class="admin-option-btn blue">ENVIAR RELATÓRIO</button>
                <button id="btn-reorganizar" class="admin-option-btn red">REORGANIZAR</button>
                <button id="btn-novo-usuario" class="admin-option-btn green">NOVO USUÁRIO</button>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Usuário -->
    <div id="add-user-modal" class="modal-overlay">
        <div class="modal-card">
            <button class="close-modal-btn" id="close-add-user-modal-btn">&times;</button>
            <h2 class="modal-title">ADICIONAR NOVO USUÁRIO</h2>
            <div class="modal-input-wrapper">
                <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                <input type="text" id="new-user-name" class="modal-input" placeholder="NOME DO FUNCIONÁRIO">
            </div>
            <div class="modal-input-wrapper">
                 <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <line x1="10" y1="9" x2="8" y2="9"/>
                </svg>
                <input type="text" id="new-user-matricula" class="modal-input" placeholder="MATRÍCULA">
            </div>
            <button id="submit-add-user-btn" class="modal-button modal-button-green">
                 <span class="button-text">ADICIONAR</span>
                 <div class="spinner"></div>
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, onSnapshot, collection, query, where, getDocs, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        (async () => {
            const firebaseConfig = {
                apiKey: "AIzaSyD2f5HOtfPSDYvadGYs42MPB7uedOSzO44",
                authDomain: "painel-dss.firebaseapp.com",
                projectId: "painel-dss",
                storageBucket: "painel-dss.appspot.com",
                messagingSenderId: "977573548445",
                appId: "1:977573548445:web:d5bb8832dd6618bc801f74"
            };
            
            const employeesCollectionPath = "/employees";
            const administratorsCollectionPath = "/administrators";
            const LAST_CLEAN_KEY = 'lastAutoCleanDate';

            let app;
            let db;
            let auth;
            let userId = null;
            let employeesCollectionRef = null;
            let administratorsCollectionRef = null;
            let unsubscribeEmployees = null;
            let employeesData = [];
            let isAdmin = false;

            const headerLoader = document.getElementById('header-loader');
            const leftColumn = document.getElementById('left-column');
            const rightColumn = document.getElementById('right-column');
            const specialTeamList = document.getElementById('special-team-list');
            const mainLoadingPlaceholder = document.getElementById('main-loading-placeholder');
            const specialLoadingPlaceholder = document.getElementById('special-loading-placeholder');
            const statBem = document.getElementById('stat-bem');
            const statMal = document.getElementById('stat-mal');
            const statAbsent = document.getElementById('stat-absent');
            const statTotal = document.getElementById('stat-total');
            
            const loginModal = document.getElementById('admin-login-modal');
            const optionsModal = document.getElementById('admin-options-modal');
            const addUserModal = document.getElementById('add-user-modal');
            
            const adminAccessBtn = document.getElementById('admin-access-btn');
            const closeLoginBtn = document.getElementById('close-login-modal-btn');
            const closeOptionsBtn = document.getElementById('close-options-modal-btn');
            const closeAddUserBtn = document.getElementById('close-add-user-modal-btn');
            const submitLoginBtn = document.getElementById('submit-login-btn');
            const btnLimpar = document.getElementById('btn-limpar');
            const btnRelatorio = document.getElementById('btn-relatorio');
            const btnReorganizar = document.getElementById('btn-reorganizar');
            const btnNovoUsuario = document.getElementById('btn-novo-usuario');
            const submitAddUserBtn = document.getElementById('submit-add-user-btn');
            const registerPresenceBtn = document.getElementById('register-presence-btn');
            const dssSubjectInput = document.getElementById('dss-subject');
            const userMatriculaInput = document.getElementById('user-matricula');
            const registerSpecialBtn = document.getElementById('register-presence-btn-special');
            const dssSubjectSpecialInput = document.getElementById('dss-subject-special');
            const userMatriculaSpecialInput = document.getElementById('user-matricula-special');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const body = document.body;
            const scalableContainer = document.getElementById('scalable-container');
            const viewport = document.getElementById('viewport');
            const newUserNameInput = document.getElementById('new-user-name');
            const newUserMatriculaInput = document.getElementById('new-user-matricula');

            function initializeFirebase() {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    employeesCollectionRef = collection(db, employeesCollectionPath);
                    administratorsCollectionRef = collection(db, administratorsCollectionPath);
                    console.log("Firebase inicializado com sucesso.");
                    return true;
                } catch (error) {
                    console.error("Erro ao inicializar Firebase:", error);
                    showNotification("Erro CRÍTICO ao inicializar conexão com banco de dados.", "error");
                    hideLoadingPlaceholders("Falha na inicialização do Firebase.");
                    if (headerLoader) headerLoader.style.opacity = '0';
                    return false;
                }
            }

            async function authenticateUser() {
                showLoadingMessage("Autenticando...");
                return new Promise((resolve, reject) => {
                    const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
                        unsubscribeAuth();
                        if (user) {
                            userId = user.uid;
                            console.log("Usuário autenticado:", userId);
                            resolve(true);
                        } else {
                            try {
                                console.log("Tentando login anônimo...");
                                const userCredential = await signInAnonymously(auth);
                                userId = userCredential.user.uid;
                                console.log("Login anônimo bem-sucedido:", userId);
                                resolve(true);
                            } catch (error) {
                                console.error("Erro no login anônimo:", error);
                                showNotification("Erro na autenticação anônima.", "error");
                                hideLoadingPlaceholders("Falha na autenticação.");
                                if (headerLoader) headerLoader.style.opacity = '0';
                                reject(error);
                            }
                        }
                    });
                });
            }

            function showNotification(message, type = 'success', duration = 3000) {
                const notificationArea = document.getElementById('notification-area');
                if (!notificationArea) return;
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                notificationArea.appendChild(notification);
                setTimeout(() => notification.classList.add('show'), 10);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 500);
                }, duration);
            }

            function createRipple(event) {
                const button = event.currentTarget;
                const oldRipple = button.querySelector('.ripple');
                if(oldRipple) oldRipple.remove();
                const ripple = document.createElement('span');
                const rect = button.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                let clientX = event.clientX;
                let clientY = event.clientY;
                if (event.touches && event.touches.length > 0) {
                    clientX = event.touches[0].clientX;
                    clientY = event.touches[0].clientY;
                }
                const x = clientX - rect.left - size / 2;
                const y = clientY - rect.top - size / 2;
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                ripple.classList.add('ripple');
                if (button.classList.contains('absent-button')) ripple.style.background = 'rgba(255, 255, 255, 0.5)';
                else ripple.style.background = 'rgba(255, 255, 255, 0.5)';
                button.appendChild(ripple);
                setTimeout(() => ripple.remove(), 600);
            }

            function showLoadingMessage(message) {
                if (mainLoadingPlaceholder) {
                    mainLoadingPlaceholder.textContent = message;
                    mainLoadingPlaceholder.classList.add('show');
                }
                if (specialLoadingPlaceholder) {
                    specialLoadingPlaceholder.textContent = message;
                    specialLoadingPlaceholder.classList.add('show');
                }
                if (leftColumn) leftColumn.innerHTML = '';
                if (rightColumn) rightColumn.innerHTML = '';
                if (specialTeamList) specialTeamList.innerHTML = '';
            }

            function hideLoadingPlaceholders(errorMessage = null) {
                if (mainLoadingPlaceholder) {
                    if (errorMessage) {
                        mainLoadingPlaceholder.textContent = errorMessage;
                        mainLoadingPlaceholder.classList.add('show');
                    } else {
                        mainLoadingPlaceholder.classList.remove('show');
                    }
                }
                if (specialLoadingPlaceholder) {
                     if (errorMessage) {
                        specialLoadingPlaceholder.textContent = errorMessage;
                        specialLoadingPlaceholder.classList.add('show');
                     } else {
                        specialLoadingPlaceholder.classList.remove('show');
                     }
                }
            }

            function openModal(modal) { if (modal) modal.classList.add('visible'); }
            function closeModal(modal) { if (modal) modal.classList.remove('visible'); }

            function setButtonLoading(button, isLoading) {
                if (!button) return;
                if (isLoading) {
                    button.classList.add('loading');
                    button.disabled = true;
                } else {
                    button.classList.remove('loading');
                    button.disabled = false;
                }
            }

            function setAdminMode(active) {
                if (active) {
                    document.body.classList.add('admin-mode');
                    isAdmin = true;
                    console.log("Modo admin ativado na UI");
                } else {
                    document.body.classList.remove('admin-mode');
                    isAdmin = false;
                    console.log("Modo admin desativado na UI");
                }
            }

            function formatFirebaseTimestamp(timestamp) {
                if (!timestamp) return null;
                if (typeof timestamp === 'string' && timestamp.match(/\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}/)) {
                    return timestamp;
                }
                if (timestamp && typeof timestamp.toDate === 'function') {
                    const date = timestamp.toDate();
                    return date.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace(',', '');
                }
                console.warn("Tipo de dados inesperado para campo 'time':", timestamp);
                return null;
            }

            function listenForEmployeeUpdates() {
                if (unsubscribeEmployees) unsubscribeEmployees();
                if (!employeesCollectionRef) {
                     console.error("Referência da coleção Firestore não definida.");
                     hideLoadingPlaceholders("Erro: Referência da coleção não definida.");
                     return;
                }

                showLoadingMessage("Buscando funcionários...");
                console.log("Anexando listener Firestore para:", employeesCollectionPath);

                unsubscribeEmployees = onSnapshot(employeesCollectionRef, (querySnapshot) => {
                    console.log("Snapshot Firestore recebido.");
                    hideLoadingPlaceholders();
                    let updatedEmployees = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const formattedTime = formatFirebaseTimestamp(data.time);

                        updatedEmployees.push({
                            docId: doc.id,
                            name: data.name || "Nome Desconhecido",
                            matricula: data.matricula || "",
                            assDss: data.assDss === true,
                            bem: data.bem === true,
                            mal: data.mal === true,
                            absent: data.absent === true,
                            time: formattedTime,
                            inSpecialTeam: data.inSpecialTeam === true,
                        });
                    });

                    updatedEmployees.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
                    employeesData = updatedEmployees;

                    console.log(`Buscados e ordenados ${employeesData.length} funcionários.`);

                    renderAllEmployees();
                    renderSpecialTeam();
                    updateAllStats();

                }, (error) => {
                    console.error("Erro ao escutar Firestore:", error);
                    showNotification("Erro ao carregar dados dos funcionários.", "error");
                    hideLoadingPlaceholders("Erro ao carregar dados. Verifique o console.");
                });
            }

            function createEmployeeBlockHTML(emp) {
                const absentButtonClass = emp.absent ? "absent-button marked" : "absent-button";
                const turnoButtonClass = emp.inSpecialTeam ? "turno-button active" : "turno-button";
                const assDssClass = emp.assDss ? 'checked-ass-dss' : '';
                const bemClass = emp.bem ? 'checked-bem' : '';
                const malClass = emp.mal ? 'checked-mal' : '';
                const displayTime = emp.time || '--:--';

                return `
                    <div class="employee-block" data-doc-id="${emp.docId}" data-matricula="${emp.matricula}">
                        <div class="employee-header">
                            <div class="employee-avatar">👤</div>
                            <div class="employee-info">
                                <div class="employee-name">${emp.name}</div>
                                <div class="employee-matricula">Matrícula: ${emp.matricula || 'N/A'}</div>
                            </div>
                            <div class="employee-header-buttons">
                                 <button class="${turnoButtonClass}" data-doc-id="${emp.docId}" data-current-state="${emp.inSpecialTeam}">
                                    <div class="turno-button-content default-state">
                                        <svg class="button-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 2h12v6h-1.5c0 1.5-1.3 2.8-3 2.9v2.2c1.7.1 3 1.4 3 2.9H18v6H6v-6h1.5c0-1.5 1.3-2.8 3-2.9v-2.2c-1.7-.1-3-1.4-3-2.9H6V2zm2 2v3.5h8V4H8zm0 13v3.5h8V17H8z" fill="currentColor"/></svg>
                                        <span>TURNO 6H</span>
                                    </div>
                                    <div class="turno-button-content loading-state"><span class="spinner"></span><span>PROCESSANDO...</span></div>
                                    <div class="progress-bar"></div>
                                </button>
                                <button class="${absentButtonClass}" data-doc-id="${emp.docId}" data-current-state="${emp.absent}">
                                    <svg class="button-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="8" cy="9" r="1.5" fill="currentColor"/><circle cx="16" cy="9" r="1.5" fill="currentColor"/><path d="M8 15 Q12 13 16 15" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
                                    <span>AUSENTE</span>
                                </button>
                                <button class="remove-button" data-doc-id="${emp.docId}">
                                    <div class="remove-button-content default-state">
                                        <svg class="button-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="currentColor"/>
                                        </svg>
                                        <span>REMOVER</span>
                                    </div>
                                    <div class="remove-button-content loading-state"><span class="spinner"></span><span>EXCLUINDO...</span></div>
                                    <div class="progress-bar"></div>
                                </button>
                            </div>
                        </div>
                        <div class="checkboxes-row">
                             <div class="checkbox-item ${assDssClass}" data-type="assDss" data-doc-id="${emp.docId}" data-current-state="${emp.assDss}">
                                <label class="checkbox-label">
                                    <span class="checkbox-icon">📄</span>
                                    <span class="checkbox-text">ASS. DSS</span>
                                    <input type="checkbox" class="real-checkbox" ${emp.assDss ? 'checked' : ''} disabled>
                                    <span class="custom-checkbox"></span>
                                </label>
                            </div>
                             <div class="checkbox-item ${bemClass}" data-type="bem" data-doc-id="${emp.docId}" data-current-state="${emp.bem}">
                                <label class="checkbox-label">
                                    <span class="checkbox-icon">🙂</span>
                                    <span class="checkbox-text">ESTOU BEM</span>
                                    <input type="checkbox" class="real-checkbox" ${emp.bem ? 'checked' : ''} disabled>
                                    <span class="custom-checkbox"></span>
                                </label>
                            </div>
                             <div class="checkbox-item ${malClass}" data-type="mal" data-doc-id="${emp.docId}" data-current-state="${emp.mal}">
                                <label class="checkbox-label">
                                    <span class="checkbox-icon">😟</span>
                                    <span class="checkbox-text">NÃO ESTOU BEM</span>
                                    <input type="checkbox" class="real-checkbox" ${emp.mal ? 'checked' : ''} disabled>
                                    <span class="custom-checkbox"></span>
                                </label>
                            </div>
                        </div>
                        <div class="timestamp-row">
                            <div class="timestamp ${emp.time ? 'has-time' : ''}">${displayTime}</div>
                            <div class="timestamp-label">DATA / HORA DA ASSINATURA</div>
                        </div>
                    </div>
                `;
            }

            function renderAllEmployees() {
                if (!leftColumn || !rightColumn) return;
                leftColumn.innerHTML = '';
                rightColumn.innerHTML = '';

                const mainEmployees = employeesData.filter(emp => !emp.inSpecialTeam);

                if (mainEmployees.length === 0) {
                    if (employeesData.length > 0) {
                        leftColumn.innerHTML = '<p class="loading-placeholder show">Nenhum funcionário neste turno.</p>';
                    }
                     if (mainLoadingPlaceholder && employeesData.length > 0) mainLoadingPlaceholder.classList.remove('show');
                } else {
                    const mid = Math.ceil(mainEmployees.length / 2);
                    mainEmployees.forEach((emp, index) => {
                        const blockHTML = createEmployeeBlockHTML(emp);
                        if (index < mid) {
                            leftColumn.innerHTML += blockHTML;
                        } else {
                            rightColumn.innerHTML += blockHTML;
                        }
                    });
                     if (mainLoadingPlaceholder) mainLoadingPlaceholder.classList.remove('show');
                }
            }

            function renderSpecialTeam() {
                if (!specialTeamList) return;
                specialTeamList.innerHTML = '';

                const specialEmployees = employeesData.filter(emp => emp.inSpecialTeam);

                if (specialEmployees.length === 0) {
                    if (employeesData.length > 0 || userId) {
                         specialTeamList.innerHTML = '<p class="loading-placeholder show">Nenhum funcionário na Turma 6H.</p>';
                    }
                    if (specialLoadingPlaceholder && employeesData.length > 0) specialLoadingPlaceholder.classList.remove('show');
                } else {
                    specialEmployees.forEach((emp) => {
                        const blockHTML = createEmployeeBlockHTML(emp);
                        specialTeamList.innerHTML += blockHTML;
                    });
                     if (specialLoadingPlaceholder) specialLoadingPlaceholder.classList.remove('show');
                }
            }

            function updateAllStats() {
                const bem = employeesData.filter(e => e.bem && !e.absent).length;
                const mal = employeesData.filter(e => e.mal && !e.absent).length;
                const absent = employeesData.filter(e => e.absent).length;
                const total = employeesData.length;

                if(statBem) statBem.textContent = bem;
                if(statMal) statMal.textContent = mal;
                if(statAbsent) statAbsent.textContent = absent;
                if(statTotal) statTotal.textContent = total;
            }

            async function handleStatusChange(docId, type) {
                if (!userId || !db) return;

                const currentEmpData = employeesData.find(e => e.docId === docId);
                if (!currentEmpData) return;

                const isChecking = !currentEmpData[type];

                if (!isChecking && !isAdmin) {
                     showNotification("Apenas administradores podem desmarcar um status.", "error");
                     console.log(`Permissão de admin negada para usuário ${userId} para desmarcar ${type} para ${docId}`);
                     return;
                }

                const empRef = doc(db, employeesCollectionPath, docId);
                let updates = {};
                let newTime = currentEmpData.time;

                if (type === 'absent') {
                    updates.absent = isChecking;
                    if (isChecking) {
                        updates.bem = false; updates.mal = false; updates.assDss = false;
                        newTime = null;
                    } else {
                        newTime = null;
                    }
                } else if (type === 'bem') {
                    updates.bem = isChecking;
                    if (isChecking) {
                        updates.mal = false; updates.absent = false; updates.assDss = true;
                        if (!currentEmpData.time && !currentEmpData.absent) newTime = getCurrentTimestamp();
                    } else {
                        const otherStatusPresent = currentEmpData.mal || (currentEmpData.assDss && !updates.assDss);
                         if (!otherStatusPresent) newTime = null;
                    }
                } else if (type === 'mal') {
                    updates.mal = isChecking;
                    if (isChecking) {
                        updates.bem = false; updates.absent = false; updates.assDss = false;
                        if (!currentEmpData.time && !currentEmpData.absent) newTime = getCurrentTimestamp();
                    } else {
                         const otherStatusPresent = currentEmpData.bem || (currentEmpData.assDss && !updates.assDss);
                         if (!otherStatusPresent) newTime = null;
                    }
                } else if (type === 'assDss') {
                    updates.assDss = isChecking;
                    if (isChecking) {
                        updates.absent = false;
                        if (!currentEmpData.bem && !currentEmpData.mal && !currentEmpData.time && !currentEmpData.absent) {
                            newTime = getCurrentTimestamp();
                        }
                    } else {
                         const otherStatusPresent = currentEmpData.bem || currentEmpData.mal;
                         if (!otherStatusPresent) newTime = null;
                    }
                }

                if (newTime !== currentEmpData.time) {
                    updates.time = newTime;
                }

                try {
                    console.log(`Atualizando documento Firestore ${docId} com:`, updates);
                    await updateDoc(empRef, updates);
                    console.log(`Documento ${docId} atualizado com sucesso.`);
                } catch (error) {
                    console.error("Erro ao atualizar status do documento:", docId, error);
                    showNotification(`Erro ao atualizar status para ${currentEmpData.name}.`, "error");
                }
            }

            async function toggleSpecialTeamFirestore(docId, currentState) {
                if (!userId || !db) return;
                const empRef = doc(db, employeesCollectionPath, docId);
                const newState = !currentState;
                try {
                    console.log(`Atualizando documento Firestore ${docId} inSpecialTeam para:`, newState);
                    await updateDoc(empRef, { inSpecialTeam: newState });
                    console.log(`Documento ${docId} inSpecialTeam atualizado com sucesso.`);
                } catch (error) {
                    console.error("Erro ao alternar status de equipe especial:", docId, error);
                    showNotification("Erro ao mover funcionário.", "error");
                }
            }

            async function findEmployeeByMatricula(matricula) {
                if (!matricula || !employeesCollectionRef) return null;
                
                try {
                    const q = query(employeesCollectionRef, where("matricula", "==", matricula));
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const doc = querySnapshot.docs[0];
                        return {
                            docId: doc.id,
                            ...doc.data()
                        };
                    }
                    return null;
                } catch (error) {
                    console.error("Erro ao buscar funcionário por matrícula:", error);
                    return null;
                }
            }

            async function updateEmployeePresence(docId, subject, isSpecialTeam = false) {
                if (!userId || !db) return false;

                const empRef = doc(db, employeesCollectionPath, docId);
                const updates = {
                    assDss: true,
                    bem: true,
                    mal: false,
                    absent: false,
                    time: getCurrentTimestamp(),
                    lastSubject: subject,
                    lastUpdate: new Date().toISOString()
                };

                if (isSpecialTeam) {
                    updates.inSpecialTeam = true;
                }

                try {
                    console.log(`Atualizando funcionário ${docId} com dados de presença:`, updates);
                    await updateDoc(empRef, updates);
                    console.log(`Presença do funcionário ${docId} atualizada com sucesso.`);
                    return true;
                } catch (error) {
                    console.error("Erro ao atualizar presença do funcionário:", docId, error);
                    return false;
                }
            }

            async function createNewEmployeeRegistration(name, matricula, subject, isSpecialTeam = false) {
                if (!userId || !employeesCollectionRef) return false;

                const newEmployee = {
                    name: name,
                    matricula: matricula,
                    assDss: true,
                    bem: true,
                    mal: false,
                    absent: false,
                    time: getCurrentTimestamp(),
                    lastSubject: subject,
                    inSpecialTeam: isSpecialTeam,
                    created: new Date().toISOString(),
                    lastUpdate: new Date().toISOString()
                };

                try {
                    console.log("Criando novo registro de funcionário:", newEmployee);
                    const docRef = await addDoc(employeesCollectionRef, newEmployee);
                    console.log("Novo funcionário registrado com ID:", docRef.id);
                    return true;
                } catch (error) {
                    console.error("Erro ao criar novo registro de funcionário:", error);
                    return false;
                }
            }

            async function performManualClean(buttonElement) {
                 if (!userId || !employeesCollectionRef) {
                     showNotification("Não conectado ao banco de dados.", "error");
                     return;
                 }
                 if (!isAdmin) {
                     showNotification("Apenas administradores podem executar a limpeza manual.", "error");
                     return;
                 }

                 setButtonLoading(buttonElement, true);
                 showNotification("Iniciando limpeza manual...", "neutral", 2000);

                 try {
                     console.log("Iniciando limpeza manual em lote...");
                     const querySnapshot = await getDocs(employeesCollectionRef);
                     const batch = writeBatch(db);
                     querySnapshot.forEach((doc) => {
                         batch.update(doc.ref, {
                             assDss: false, bem: false, mal: false, absent: false, time: null
                         });
                     });
                     await batch.commit();
                     console.log("Limpeza manual em lote bem-sucedida.");
                     if(dssSubjectSpecialInput) dssSubjectSpecialInput.value = '';
                     if(userMatriculaSpecialInput) userMatriculaSpecialInput.value = '';
                     if(dssSubjectInput) dssSubjectInput.value = '';
                     if(userMatriculaInput) userMatriculaInput.value = '';
                     showNotification('Limpeza manual realizada com sucesso!', 'success');
                 } catch (error) {
                     console.error("Erro ao executar limpeza manual:", error);
                     showNotification("Erro ao executar a limpeza manual.", "error");
                 } finally {
                     setButtonLoading(buttonElement, false);
                     closeModal(optionsModal);
                 }
             }

            async function performAutoClean() {
                if (!userId || !employeesCollectionRef) return;

                console.log("Executando limpeza automática...");
                try {
                    const querySnapshot = await getDocs(employeesCollectionRef);
                    const batch = writeBatch(db);
                    querySnapshot.forEach((doc) => {
                        batch.update(doc.ref, {
                            assDss: false, bem: false, mal: false, absent: false, time: null
                        });
                    });
                    await batch.commit();
                    localStorage.setItem(LAST_CLEAN_KEY, new Date().toISOString().split('T')[0]);
                    console.log("Limpeza automática bem-sucedida.");
                     if(dssSubjectSpecialInput) dssSubjectSpecialInput.value = '';
                     if(userMatriculaSpecialInput) userMatriculaSpecialInput.value = '';
                     if(dssSubjectInput) dssSubjectInput.value = '';
                     if(userMatriculaInput) userMatriculaInput.value = '';
                    showNotification("Limpeza automática executada com sucesso!", "success");
                } catch (error) {
                    console.error("Erro durante a limpeza automática:", error);
                    showNotification("Erro durante a limpeza automática.", "error");
                }
            }

            function checkAndPerformAutoClean() {
                try {
                     const today = new Date();
                     const dayOfMonth = today.getDate();
                     const todayDateString = today.toISOString().split('T')[0];
                     const lastCleanDate = localStorage.getItem(LAST_CLEAN_KEY);

                     const remainder = dayOfMonth % 4;
                     const isCleaningDay = remainder === 2 || remainder === 3;

                     console.log(`Verificando limpeza automática: Hoje=${todayDateString}, Dia=${dayOfMonth}, isCleaningDay=${isCleaningDay}, lastClean=${lastCleanDate}`);

                     if (isCleaningDay && lastCleanDate !== todayDateString) {
                         console.log("Condições atendidas para limpeza automática.");
                         performAutoClean();
                     } else {
                          console.log("Limpeza automática não necessária hoje ou já realizada.");
                     }
                } catch (error) {
                     console.error("Erro em checkAndPerformAutoClean:", error);
                }
            }

            async function handleRemoveUser(docId) {
                if (!userId || !db) return;
                if (!isAdmin) {
                    showNotification("Apenas administradores podem remover usuários.", "error");
                    return;
                }

                const empRef = doc(db, employeesCollectionPath, docId);
                try {
                    console.log(`Removendo usuário com ID: ${docId}`);
                    await deleteDoc(empRef);
                    console.log(`Usuário com ID ${docId} removido com sucesso.`);
                    showNotification('Usuário removido com sucesso!', 'success');
                } catch (error) {
                    console.error("Erro ao remover usuário:", error);
                    showNotification("Erro ao remover usuário.", "error");
                }
            }

            function setupEventListeners() {
                tableContainer?.addEventListener('click', handleInteraction);
                specialTeamList?.addEventListener('click', handleInteraction);

                registerPresenceBtn?.addEventListener('click', handleRegisterClick);
                registerSpecialBtn?.addEventListener('click', handleRegisterClick);

                darkModeToggle?.addEventListener('change', handleDarkModeToggle);

                adminAccessBtn?.addEventListener('click', handleAdminAccessClick);
                closeLoginBtn?.addEventListener('click', () => closeModal(loginModal));
                closeOptionsBtn?.addEventListener('click', () => closeModal(optionsModal));
                closeAddUserBtn?.addEventListener('click', () => closeModal(addUserModal));
                submitLoginBtn?.addEventListener('click', handleSubmitLogin);
                btnLimpar?.addEventListener('click', (e) => { createRipple(e); performManualClean(e.currentTarget); });
                btnRelatorio?.addEventListener('click', handleReportClick);
                btnReorganizar?.addEventListener('click', handleReorganizeClick);
                btnNovoUsuario?.addEventListener('click', handleNewUserClick);
                submitAddUserBtn?.addEventListener('click', handleSubmitAddUser);

                [loginModal, optionsModal, addUserModal].forEach(modal => {
                    modal?.addEventListener('click', (e) => {
                        if (e.target === modal) closeModal(modal);
                    });
                });

                newUserNameInput?.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });

                setupFormSubmitListeners();
                
                if (viewport && scalableContainer) {
                    setupZoomListeners();
                }
            }

            async function handleInteraction(e) {
                const target = e.target;

                const checkboxItem = target.closest('.checkbox-item');
                if (checkboxItem) {
                    if (target.classList.contains('real-checkbox')) return;
                    const docId = checkboxItem.dataset.docId;
                    const type = checkboxItem.dataset.type;
                    if (docId && type) {
                        checkboxItem.style.opacity = '0.7';
                        await handleStatusChange(docId, type);
                        const currentItem = document.querySelector(`.checkbox-item[data-doc-id='${docId}'][data-type='${type}']`);
                        if(currentItem) currentItem.style.opacity = '1';
                    }
                    return;
                }

                const absentButton = target.closest('.absent-button');
                if (absentButton) {
                    createRipple(e);
                    const docId = absentButton.dataset.docId;
                    if (docId) {
                        setButtonLoading(absentButton, true);
                        await handleStatusChange(docId, 'absent');
                        setButtonLoading(absentButton, false);
                    }
                    return;
                }

                const turnoButton = target.closest('.turno-button');
                if (turnoButton) {
                    createRipple(e);
                    const docId = turnoButton.dataset.docId;
                    const currentState = turnoButton.dataset.currentState === 'true';
                    if (docId) {
                        setButtonLoading(turnoButton, true);
                        await toggleSpecialTeamFirestore(docId, currentState);
                    }
                    return;
                }

                const removeButton = target.closest('.remove-button');
                if (removeButton) {
                    createRipple(e);
                    const docId = removeButton.dataset.docId;
                    if (docId) {
                        setButtonLoading(removeButton, true);
                        await handleRemoveUser(docId);
                    }
                    return;
                }
            }

            async function handleRegisterClick(e) {
                createRipple(e);
                const button = e.currentTarget;
                const isSpecial = button.id === 'register-presence-btn-special';
                
                const subjectInput = isSpecial ? dssSubjectSpecialInput : dssSubjectInput;
                const matriculaInput = isSpecial ? userMatriculaSpecialInput : userMatriculaInput;
                
                const subject = subjectInput?.value.trim();
                const matricula = matriculaInput?.value.trim();

                if (!subject) {
                    showNotification(`Por favor, informe o assunto do DSS (${isSpecial ? '6H' : '7H-19H'}).`, 'error');
                    subjectInput?.focus();
                    return;
                }

                if (!matricula) {
                    showNotification(`Por favor, informe sua matrícula (${isSpecial ? '6H' : '7H-19H'}).`, 'error');
                    matriculaInput?.focus();
                    return;
                }

                setButtonLoading(button, true);
                let progressBar = button.querySelector('.progress-bar');
                if (!progressBar) {
                    progressBar = document.createElement('div');
                    progressBar.className = 'progress-bar';
                    button.appendChild(progressBar);
                }

                try {
                    console.log(`Processando registro para matrícula: ${matricula}, Assunto: ${subject}, Especial: ${isSpecial}`);
                    
                    const existingEmployee = await findEmployeeByMatricula(matricula);
                    
                    let success = false;
                    
                    if (existingEmployee) {
                        success = await updateEmployeePresence(existingEmployee.docId, subject, isSpecial);
                        if (success) {
                            console.log(`Funcionário existente atualizado com sucesso: ${existingEmployee.name}`);
                        }
                    } else {
                        const tempName = `Funcionário ${matricula}`;
                        success = await createNewEmployeeRegistration(tempName, matricula, subject, isSpecial);
                        if (success) {
                            console.log(`Novo registro de funcionário criado com sucesso para matrícula: ${matricula}`);
                            showNotification(`Novo funcionário registrado. Por favor, um administrador deve atualizar o nome.`, 'success');
                        }
                    }

                    if (success) {
                        showNotification(`Presença registrada com sucesso! ${isSpecial ? '(Turma 6H)' : '(Turno 7H-19H)'}`, 'success');
                        
                        if (subjectInput) subjectInput.value = '';
                        if (matriculaInput) matriculaInput.value = '';
                    } else {
                        showNotification('Erro ao registrar presença. Tente novamente.', 'error');
                    }

                } catch (error) {
                    console.error("Erro no processo de registro:", error);
                    showNotification('Erro ao processar registro. Tente novamente.', 'error');
                } finally {
                    setButtonLoading(button, false);
                }
            }

            function handleDarkModeToggle() {
                body.classList.toggle('dark-mode');
                localStorage.setItem('theme', body.classList.contains('dark-mode') ? 'dark' : 'light');
            }

            function handleAdminAccessClick(e) {
                createRipple(e);
                setButtonLoading(adminAccessBtn, true);
                setTimeout(() => {
                    setButtonLoading(adminAccessBtn, false);
                    openModal(loginModal);
                }, 800);
            }

            async function handleSubmitLogin(e) {
                createRipple(e);
                if (!administratorsCollectionRef) {
                    showNotification("Erro: Conexão com a lista de administradores falhou.", "error");
                    return;
                }
                const emailInput = document.getElementById('admin-email-input');
                const email = emailInput?.value.trim().toLowerCase();

                if (!email || !email.includes('@')) {
                    emailInput?.classList.add('error');
                    showNotification("Por favor, digite um e-mail válido.", "error");
                    return;
                }
                emailInput?.classList.remove('error');
                setButtonLoading(submitLoginBtn, true);

                try {
                    const q = query(administratorsCollectionRef, where("email", "==", email));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        setAdminMode(true);
                        console.log("Login de admin bem-sucedido para:", email);
                        closeModal(loginModal);
                        showNotification('Login de administrador efetuado com sucesso!');
                        openModal(optionsModal);
                    } else {
                        setAdminMode(false);
                        console.log("Login de admin falhou para:", email);
                        showNotification('E-mail não autorizado para acesso administrativo.', 'error');
                    }
                } catch (error) {
                    setAdminMode(false);
                    console.error("Erro ao verificar e-mail de admin:", error);
                    showNotification("Erro ao verificar permissão de administrador.", "error");
                } finally {
                    setButtonLoading(submitLoginBtn, false);
                }
            }

             function handleReportClick(e) {
                createRipple(e);
                closeModal(optionsModal);
                showNotification('Funcionalidade de relatório não implementada.');
            }

            async function handleReorganizeClick(e) {
                createRipple(e);
                if (!isAdmin) {
                     showNotification("Apenas administradores podem reorganizar.", "error");
                     return;
                }
                if (!userId || !employeesCollectionRef) {
                    showNotification("Não conectado ao banco de dados.", "error");
                    return;
                }
                const button = e.currentTarget;
                setButtonLoading(button, true);

                try {
                    console.log("Iniciando atualização em lote para resetar inSpecialTeam...");
                    const q = query(employeesCollectionRef, where("inSpecialTeam", "==", true));
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) {
                         showNotification('Nenhum funcionário na Turma 6H para reorganizar.');
                         return;
                    }
                    const batch = writeBatch(db);
                    querySnapshot.forEach((doc) => {
                        batch.update(doc.ref, { inSpecialTeam: false });
                    });
                    await batch.commit();
                    console.log("Atualização em lote bem-sucedida. inSpecialTeam resetado.");
                    showNotification('Funcionários removidos da Turma 6H! O painel será reorganizado.');
                } catch (error) {
                    console.error("Erro ao resetar inSpecialTeam:", error);
                    showNotification("Erro ao reorganizar.", "error");
                } finally {
                    setButtonLoading(button, false);
                    closeModal(optionsModal);
                }
            }

            function handleNewUserClick(e) {
                createRipple(e);
                if (!isAdmin) {
                     showNotification("Apenas administradores podem adicionar usuários.", "error");
                     return;
                }
                closeModal(optionsModal);
                if(newUserNameInput) newUserNameInput.value = '';
                if(newUserMatriculaInput) newUserMatriculaInput.value = '';
                if(newUserNameInput) newUserNameInput.classList.remove('error');
                if(newUserMatriculaInput) newUserMatriculaInput.classList.remove('error');
                openModal(addUserModal);
            }

            async function handleSubmitAddUser(e) {
                createRipple(e);
                if (!isAdmin) {
                     showNotification("Apenas administradores podem adicionar usuários.", "error");
                     return;
                }
                if (!userId || !employeesCollectionRef) {
                    showNotification("Não conectado ao banco de dados.", "error");
                    return;
                }

                const name = newUserNameInput?.value.trim().toUpperCase();
                const matricula = newUserMatriculaInput?.value.trim();

                let hasError = false;
                if (!name) {
                    newUserNameInput?.classList.add('error');
                    hasError = true;
                } else {
                    newUserNameInput?.classList.remove('error');
                }

                if (hasError) {
                     showNotification('O campo Nome é obrigatório.', 'error');
                     return;
                }

                setButtonLoading(submitAddUserBtn, true);

                try {
                     if (matricula) {
                         console.log("Verificando se matrícula existe:", matricula);
                         const q = query(employeesCollectionRef, where("matricula", "==", matricula));
                         const querySnapshot = await getDocs(q);
                         if (!querySnapshot.empty) {
                             newUserMatriculaInput?.classList.add('error');
                             showNotification('Essa matrícula já existe no banco de dados.', 'error');
                             setButtonLoading(submitAddUserBtn, false);
                             return;
                         }
                          newUserMatriculaInput?.classList.remove('error');
                     }

                    const newUser = {
                        name: name,
                        matricula: matricula || "",
                        assDss: false, bem: false, mal: false, absent: false,
                        time: null, inSpecialTeam: false
                    };

                    console.log("Adicionando novo usuário ao Firestore:", newUser);
                    const docRef = await addDoc(employeesCollectionRef, newUser);
                    console.log("Novo usuário adicionado com ID:", docRef.id);
                    showNotification(`Usuário ${name} adicionado!`, 'success');
                    closeModal(addUserModal);

                } catch (error) {
                    console.error("Erro ao adicionar novo usuário:", error);
                    showNotification("Erro ao adicionar usuário.", "error");
                } finally {
                    setButtonLoading(submitAddUserBtn, false);
                }
            }

            function setupFormSubmitListeners() {
                userMatriculaInput?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleRegisterClick({ currentTarget: registerPresenceBtn });
                    }
                });

                dssSubjectInput?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleRegisterClick({ currentTarget: registerPresenceBtn });
                    }
                });

                userMatriculaSpecialInput?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleRegisterClick({ currentTarget: registerSpecialBtn });
                    }
                });

                dssSubjectSpecialInput?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleRegisterClick({ currentTarget: registerSpecialBtn });
                    }
                });
            }

            let currentScale = 1;
            let initialDistance = 0;
            let initialScale = 1;
            let touchCenter = { x: 0, y: 0 };
            let zoomScrollStart = { x: 0, y: 0 };

            function setScale(scale) {
                currentScale = Math.max(0.2, Math.min(5, scale));
                if (scalableContainer) {
                    scalableContainer.style.transform = `scale(${currentScale})`;
                }
            }

             function initializeScale() {
                setTimeout(() => {
                     if (!viewport || !scalableContainer) return;
                     const isMobile = window.innerWidth < 768;
                     let startingScale = 1;
                     if (isMobile) {
                         const containerWidth = scalableContainer.offsetWidth || 2448;
                         startingScale = window.innerWidth / containerWidth;
                     }
                     setScale(startingScale);
                     viewport.scrollLeft = 0;
                     viewport.scrollTop = 0;
                     console.log("Escala inicial definida para:", currentScale);
                }, 100);
            }

            function setupZoomListeners() {
                viewport.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 2) {
                        e.preventDefault();
                        initialDistance = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                        initialScale = currentScale;
                        const rect = viewport.getBoundingClientRect();
                        touchCenter.x = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left + viewport.scrollLeft;
                        touchCenter.y = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top + viewport.scrollTop;
                        zoomScrollStart.x = viewport.scrollLeft;
                        zoomScrollStart.y = viewport.scrollTop;
                    }
                }, { passive: false });

                viewport.addEventListener('touchmove', (e) => {
                     if (e.touches.length === 2) {
                        e.preventDefault();
                        if (initialDistance === 0) return;
                        const currentDistance = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                        const newScale = initialScale * (currentDistance / initialDistance);
                        const scaleRatio = newScale / currentScale;

                        const newScrollLeft = touchCenter.x * scaleRatio - (touchCenter.x - zoomScrollStart.x);
                        const newScrollTop = touchCenter.y * scaleRatio - (touchCenter.y - zoomScrollStart.y);

                        setScale(newScale);
                        viewport.scrollLeft = newScrollLeft;
                        viewport.scrollTop = newScrollTop;
                    }
                }, { passive: false });

                viewport.addEventListener('wheel', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        const delta = e.deltaY > 0 ? -1 : 1;
                        const zoomIntensity = 0.1;
                        const oldScale = currentScale;
                        const newScale = oldScale * (1 + delta * zoomIntensity);
                        const scaleRatio = newScale / oldScale;

                         const rect = viewport.getBoundingClientRect();
                         const mouseX = e.clientX - rect.left + viewport.scrollLeft;
                         const mouseY = e.clientY - rect.top + viewport.scrollTop;

                        const newScrollLeft = mouseX * scaleRatio - (mouseX - viewport.scrollLeft);
                        const newScrollTop = mouseY * scaleRatio - (mouseY - viewport.scrollTop);

                        setScale(newScale);
                        viewport.scrollLeft = newScrollLeft;
                        viewport.scrollTop = newScrollTop;
                    }
                }, { passive: false });

                window.addEventListener('resize', initializeScale);
            }

            if (initializeFirebase()) {
                await authenticateUser();
                if (userId) {
                    listenForEmployeeUpdates();
                     checkAndPerformAutoClean();
                }
                setupEventListeners();
                initializeScale();
            } else {
                if(headerLoader) headerLoader.style.opacity = '0';
            }

        })();

        function getCurrentTimestamp() {
            const now = new Date();
            return now.toLocaleString('pt-BR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            }).replace(',', '');
        }
    </script>
</body>
</html>